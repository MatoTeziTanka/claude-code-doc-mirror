#!/bin/bash
# claude-docs-sync.sh - Mirror Claude Code documentation with change tracking
# Purpose: Fetch docs, detect changes, and optionally record in a knowledge graph
# Usage: ./claude-docs-sync.sh [--force]
#
# Configuration via environment variables:
#   DOC_MIRROR_BASE  - Root directory of this tool (defaults to current directory)
#   GRAPH            - Path to a JSONL file for knowledge-graph integration.
#                      If unset, graph logging is skipped entirely.
#
# Example:
#   export DOC_MIRROR_BASE="/opt/doc-mirror"
#   export GRAPH="/opt/graph/nodes.jsonl"   # optional
#   ./bin/claude-docs-sync.sh
#
# Created: 2026-01-27

set -uo pipefail
# Note: -e removed because ((counter++)) returns 1 when counter=0, which exits

# === CONFIGURATION ===
# DOC_MIRROR_BASE: set this to the root of your doc-mirror checkout.
# Defaults to the current working directory if not set.
BASE="${DOC_MIRROR_BASE:-.}"
TOOL_DIR="$BASE"
DATA_DIR="$TOOL_DIR/data/claude-code/en"
LOG_DIR="$TOOL_DIR/logs"
# GRAPH: path to a JSONL knowledge-graph file.
# Leave unset to disable graph integration entirely.
GRAPH="${GRAPH:-}"
MANIFEST="$TOOL_DIR/data/claude-code/hashes.manifest"
CHANGELOG="$TOOL_DIR/data/claude-code/CHANGELOG.md"

BASE_URL="https://code.claude.com/docs/en"

# All 51 documentation pages
PAGES=(
    "amazon-bedrock.md"
    "analytics.md"
    "best-practices.md"
    "changelog.md"
    "checkpointing.md"
    "chrome.md"
    "claude-code-on-the-web.md"
    "cli-reference.md"
    "common-workflows.md"
    "costs.md"
    "data-usage.md"
    "desktop.md"
    "devcontainer.md"
    "discover-plugins.md"
    "features-overview.md"
    "github-actions.md"
    "gitlab-ci-cd.md"
    "google-vertex-ai.md"
    "headless.md"
    "hooks.md"
    "hooks-guide.md"
    "how-claude-code-works.md"
    "iam.md"
    "interactive-mode.md"
    "jetbrains.md"
    "legal-and-compliance.md"
    "llm-gateway.md"
    "mcp.md"
    "memory.md"
    "microsoft-foundry.md"
    "model-config.md"
    "monitoring-usage.md"
    "network-config.md"
    "output-styles.md"
    "overview.md"
    "plugin-marketplaces.md"
    "plugins.md"
    "plugins-reference.md"
    "quickstart.md"
    "sandboxing.md"
    "security.md"
    "settings.md"
    "setup.md"
    "skills.md"
    "slack.md"
    "statusline.md"
    "sub-agents.md"
    "terminal-config.md"
    "third-party-integrations.md"
    "troubleshooting.md"
    "vs-code.md"
)

# === FUNCTIONS ===

log() {
    local ts
    ts=$(date -u +%Y-%m-%dT%H:%M:%SZ)
    echo "[$ts] $*" | tee -a "$LOG_DIR/sync.log"
}

get_hash() {
    local file="$1"
    if [[ -f "$file" ]]; then
        sha256sum "$file" | cut -d' ' -f1
    else
        echo "NONE"
    fi
}

graph_change() {
    # Skip if graph integration is not configured
    [[ -z "${GRAPH:-}" ]] && return 0

    local page="$1"
    local change_type="$2"  # new | modified | deleted
    local old_hash="$3"
    local new_hash="$4"

    local ts
    ts=$(date -u +%Y-%m-%dT%H:%M:%S.%6NZ)
    local date_part
    date_part=$(date +%Y-%m-%d)
    local node_id="DOC-MIRROR-claude-code-${page%.md}-$date_part"

    # Append to graph
    echo "{\"id\": \"$node_id\", \"kind\": \"doc-mirror-change\", \"source\": \"claude-code\", \"page\": \"$page\", \"change_type\": \"$change_type\", \"old_hash\": \"$old_hash\", \"new_hash\": \"$new_hash\", \"detected_at\": \"$ts\"}" >> "$GRAPH"

    log "GRAPHED: $node_id ($change_type)"
}

update_changelog() {
    local page="$1"
    local change_type="$2"
    local ts
    ts=$(date -u +%Y-%m-%dT%H:%M:%SZ)

    # Create changelog if doesn't exist
    if [[ ! -f "$CHANGELOG" ]]; then
        cat > "$CHANGELOG" << 'HEADER'
# Claude Code Documentation Changelog
# Auto-generated by claude-docs-sync.sh

HEADER
    fi

    echo "- [$ts] **$change_type**: $page" >> "$CHANGELOG"
}

fetch_page() {
    local page="$1"
    local url="$BASE_URL/$page"
    local dest="$DATA_DIR/$page"
    local tmp_file
    tmp_file=$(mktemp)

    # Fetch with curl
    if curl -sfL "$url" -o "$tmp_file" 2>/dev/null; then
        # Get hashes
        local old_hash
        old_hash=$(get_hash "$dest")
        local new_hash
        new_hash=$(sha256sum "$tmp_file" | cut -d' ' -f1)

        if [[ "$old_hash" == "NONE" ]]; then
            # New file
            mv "$tmp_file" "$dest"
            log "NEW: $page"
            graph_change "$page" "new" "$old_hash" "$new_hash"
            update_changelog "$page" "NEW"
            echo "$page:$new_hash" >> "$MANIFEST.tmp"
            return 0
        elif [[ "$old_hash" != "$new_hash" ]]; then
            # Modified
            mv "$tmp_file" "$dest"
            log "MODIFIED: $page (${old_hash:0:8}... -> ${new_hash:0:8}...)"
            graph_change "$page" "modified" "$old_hash" "$new_hash"
            update_changelog "$page" "MODIFIED"
            echo "$page:$new_hash" >> "$MANIFEST.tmp"
            return 0
        else
            # Unchanged
            rm "$tmp_file"
            echo "$page:$new_hash" >> "$MANIFEST.tmp"
            return 1
        fi
    else
        log "FETCH FAILED: $page"
        rm -f "$tmp_file"
        # Preserve old hash if fetch fails
        local old_hash
        old_hash=$(get_hash "$dest")
        if [[ "$old_hash" != "NONE" ]]; then
            echo "$page:$old_hash" >> "$MANIFEST.tmp"
        fi
        return 2
    fi
}

# === MAIN ===

log "=== CLAUDE DOCS SYNC STARTED ==="

# Initialize counters
total=0
new_count=0
modified_count=0
unchanged_count=0
failed_count=0

# Clear temp manifest
rm -f "$MANIFEST.tmp"
touch "$MANIFEST.tmp"

# Process each page
for page in "${PAGES[@]}"; do
    ((total++))

    result=0
    fetch_page "$page" || result=$?

    case $result in
        0)
            if [[ $(get_hash "$DATA_DIR/$page") != "NONE" ]]; then
                # Could be new or modified, check log
                if grep -q "NEW: $page" "$LOG_DIR/sync.log" 2>/dev/null; then
                    ((new_count++))
                else
                    ((modified_count++))
                fi
            fi
            ;;
        1)
            ((unchanged_count++))
            ;;
        2)
            ((failed_count++))
            ;;
    esac
done

# Update manifest
mv "$MANIFEST.tmp" "$MANIFEST"

# Summary
log "=== SYNC COMPLETE ==="
log "Total: $total | New: $new_count | Modified: $modified_count | Unchanged: $unchanged_count | Failed: $failed_count"

# Graph sync event (only if graph integration is configured)
if [[ -n "${GRAPH:-}" ]]; then
    ts=$(date -u +%Y-%m-%dT%H:%M:%S.%6NZ)
    date_part=$(date +%Y-%m-%d)
    echo "{\"id\": \"DOC-SYNC-claude-code-$date_part\", \"kind\": \"doc-sync-run\", \"source\": \"claude-code\", \"total\": $total, \"new\": $new_count, \"modified\": $modified_count, \"unchanged\": $unchanged_count, \"failed\": $failed_count, \"timestamp\": \"$ts\"}" >> "$GRAPH"
    log "Sync run graphed: DOC-SYNC-claude-code-$date_part"
fi

# Exit with appropriate code
if [[ $failed_count -gt 0 ]]; then
    exit 1
elif [[ $((new_count + modified_count)) -gt 0 ]]; then
    exit 0
else
    exit 0
fi
